// *********************************************************************************************************************
// ***                                        CONFIDENTIAL --- CUSTOM STUDIOS                                        ***
// *********************************************************************************************************************
// * Auth: ColeCai                                                                                                     *
// * Date: 2023/10/30 16:06:01                                                                                         *
// * Proj: gotils                                                                                                      *
// * Pack: saferplus                                                                                                    *
// * File: internal.go                                                                                                 *
// *-------------------------------------------------------------------------------------------------------------------*
// * Overviews:                                                                                                        *
// *-------------------------------------------------------------------------------------------------------------------*
// * Functions:                                                                                                        *
// * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *

package safeplus

import "github.com/caijunjun/gotils/tools"

// *********************************************************************************************************************
// * SUMMARY: none.                                                                                                    *
// * WARNING: none.                                                                                                    *
// * HISTORY:                                                                                                          *
// *    -create: 2023/10/30 16:12:14 ColeCai.                                                                          *
// *********************************************************************************************************************
func doFr(x []byte, kp []byte) {
	x[0] = saferExpf[x[0]^kp[0]] + kp[16]
	x[1] = saferLogf[x[1]+kp[1]] ^ kp[17]
	x[2] = saferLogf[x[2]+kp[2]] ^ kp[18]
	x[3] = saferExpf[x[3]^kp[3]] + kp[19]

	x[4] = saferExpf[x[4]^kp[4]] + kp[20]
	x[5] = saferLogf[x[5]+kp[5]] ^ kp[21]
	x[6] = saferLogf[x[6]+kp[6]] ^ kp[22]
	x[7] = saferExpf[x[7]^kp[7]] + kp[23]

	x[8] = saferExpf[x[8]^kp[8]] + kp[24]
	x[9] = saferLogf[x[9]+kp[9]] ^ kp[25]
	x[10] = saferLogf[x[10]+kp[10]] ^ kp[26]
	x[11] = saferExpf[x[11]^kp[11]] + kp[27]

	x[12] = saferExpf[x[12]^kp[12]] + kp[28]
	x[13] = saferLogf[x[13]+kp[13]] ^ kp[29]
	x[14] = saferLogf[x[14]+kp[14]] ^ kp[30]
	x[15] = saferExpf[x[15]^kp[15]] + kp[31]

	x[1] += x[0]
	x[0] += x[1]
	x[3] += x[2]
	x[2] += x[3]
	x[5] += x[4]
	x[4] += x[5]
	x[7] += x[6]
	x[6] += x[7]
	x[9] += x[8]
	x[8] += x[9]
	x[11] += x[10]
	x[10] += x[11]
	x[13] += x[12]
	x[12] += x[13]
	x[15] += x[14]
	x[14] += x[15]

	x[7] += x[0]
	x[0] += x[7]
	x[1] += x[2]
	x[2] += x[1]
	x[3] += x[4]
	x[4] += x[3]
	x[5] += x[6]
	x[6] += x[5]
	x[11] += x[8]
	x[8] += x[11]
	x[9] += x[10]
	x[10] += x[9]
	x[15] += x[12]
	x[12] += x[15]
	x[13] += x[14]
	x[14] += x[13]

	x[3] += x[0]
	x[0] += x[3]
	x[15] += x[2]
	x[2] += x[15]
	x[7] += x[4]
	x[4] += x[7]
	x[1] += x[6]
	x[6] += x[1]
	x[5] += x[8]
	x[8] += x[5]
	x[13] += x[10]
	x[10] += x[13]
	x[11] += x[12]
	x[12] += x[11]
	x[9] += x[14]
	x[14] += x[9]

	x[13] += x[0]
	x[0] += x[13]
	x[5] += x[2]
	x[2] += x[5]
	x[9] += x[4]
	x[4] += x[9]
	x[11] += x[6]
	x[6] += x[11]
	x[15] += x[8]
	x[8] += x[15]
	x[1] += x[10]
	x[10] += x[1]
	x[3] += x[12]
	x[12] += x[3]
	x[7] += x[14]
	x[14] += x[7]

	t := x[0]
	x[0] = x[14]
	x[14] = x[12]
	x[12] = x[10]
	x[10] = x[2]
	x[2] = x[8]
	x[8] = x[4]
	x[4] = t

	t = x[1]
	x[1] = x[7]
	x[7] = x[11]
	x[11] = x[5]
	x[5] = x[13]
	x[13] = t

	t = x[15]
	x[15] = x[3]
	x[3] = t
}

// *********************************************************************************************************************
// * SUMMARY: none.                                                                                                    *
// * WARNING: none.                                                                                                    *
// * HISTORY:                                                                                                          *
// *    -create: 2023/10/30 16:12:19 ColeCai.                                                                          *
// *********************************************************************************************************************
func doIr(x []byte, kp []byte) {
	t := x[3]
	x[3] = x[15]
	x[15] = t

	t = x[13]
	x[13] = x[5]
	x[5] = x[11]
	x[11] = x[7]
	x[7] = x[1]
	x[1] = t

	t = x[4]
	x[4] = x[8]
	x[8] = x[2]
	x[2] = x[10]
	x[10] = x[12]
	x[12] = x[14]
	x[14] = x[0]
	x[0] = t

	x[14] -= x[7]
	x[7] -= x[14]
	x[12] -= x[3]
	x[3] -= x[12]
	x[10] -= x[1]
	x[1] -= x[10]
	x[8] -= x[15]
	x[15] -= x[8]
	x[6] -= x[11]
	x[11] -= x[6]
	x[4] -= x[9]
	x[9] -= x[4]
	x[2] -= x[5]
	x[5] -= x[2]
	x[0] -= x[13]
	x[13] -= x[0]

	x[14] -= x[9]
	x[9] -= x[14]
	x[12] -= x[11]
	x[11] -= x[12]
	x[10] -= x[13]
	x[13] -= x[10]
	x[8] -= x[5]
	x[5] -= x[8]
	x[6] -= x[1]
	x[1] -= x[6]
	x[4] -= x[7]
	x[7] -= x[4]
	x[2] -= x[15]
	x[15] -= x[2]
	x[0] -= x[3]
	x[3] -= x[0]

	x[14] -= x[13]
	x[13] -= x[14]
	x[12] -= x[15]
	x[15] -= x[12]
	x[10] -= x[9]
	x[9] -= x[10]
	x[8] -= x[11]
	x[11] -= x[8]
	x[6] -= x[5]
	x[5] -= x[6]
	x[4] -= x[3]
	x[3] -= x[4]
	x[2] -= x[1]
	x[1] -= x[2]
	x[0] -= x[7]
	x[7] -= x[0]

	x[14] -= x[15]
	x[15] -= x[14]
	x[12] -= x[13]
	x[13] -= x[12]
	x[10] -= x[11]
	x[11] -= x[10]
	x[8] -= x[9]
	x[9] -= x[8]
	x[6] -= x[7]
	x[7] -= x[6]
	x[4] -= x[5]
	x[5] -= x[4]
	x[2] -= x[3]
	x[3] -= x[2]
	x[0] -= x[1]
	x[1] -= x[0]

	x[0] = saferLogf[int(x[0]-kp[16])+256] ^ kp[0]
	x[1] = saferExpf[x[1]^kp[17]] - kp[1]
	x[2] = saferExpf[x[2]^kp[18]] - kp[2]
	x[3] = saferLogf[int(x[3]-kp[19])+256] ^ kp[3]

	x[4] = saferLogf[int(x[4]-kp[20])+256] ^ kp[4]
	x[5] = saferExpf[x[5]^kp[21]] - kp[5]
	x[6] = saferExpf[x[6]^kp[22]] - kp[6]
	x[7] = saferLogf[int(x[7]-kp[23])+256] ^ kp[7]

	x[8] = saferLogf[int(x[8]-kp[24])+256] ^ kp[8]
	x[9] = saferExpf[x[9]^kp[25]] - kp[9]
	x[10] = saferExpf[x[10]^kp[26]] - kp[10]
	x[11] = saferLogf[int(x[11]-kp[27])+256] ^ kp[11]

	x[12] = saferLogf[int(x[12]-kp[28])+256] ^ kp[12]
	x[13] = saferExpf[x[13]^kp[29]] - kp[13]
	x[14] = saferExpf[x[14]^kp[30]] - kp[14]
	x[15] = saferLogf[int(x[15]-kp[31])+256] ^ kp[15]
}

// *********************************************************************************************************************
// * SUMMARY: none.                                                                                                    *
// * WARNING: none.                                                                                                    *
// * HISTORY:                                                                                                          *
// *    -create: 2023/10/30 16:12:37 ColeCai.                                                                          *
// *********************************************************************************************************************
func encrypt(xk []byte, kBytes uint32, dst, src []uint32) {
	__blk := make([]uint32, 16)
	blk := tools.IntegersToBytes(__blk)

	__blk[3] = src[0]
	__blk[2] = src[1]
	__blk[1] = src[2]
	__blk[0] = src[3]

	doFr(blk, xk)
	doFr(blk, xk[32:])
	doFr(blk, xk[64:])
	doFr(blk, xk[96:])
	doFr(blk, xk[128:])
	doFr(blk, xk[160:])
	doFr(blk, xk[192:])
	doFr(blk, xk[224:])

	if kBytes > 16 {
		doFr(blk, xk[256:])
		doFr(blk, xk[288:])
		doFr(blk, xk[320:])
		doFr(blk, xk[352:])
	}

	if kBytes > 24 {
		doFr(blk, xk[384:])
		doFr(blk, xk[416:])
		doFr(blk, xk[448:])
		doFr(blk, xk[480:])
	}

	kp := xk[16*kBytes:]

	blk[0] ^= kp[0]
	blk[1] += kp[1]
	blk[2] += kp[2]
	blk[3] ^= kp[3]
	blk[4] ^= kp[4]
	blk[5] += kp[5]
	blk[6] += kp[6]
	blk[7] ^= kp[7]
	blk[8] ^= kp[8]
	blk[9] += kp[9]
	blk[10] += kp[10]
	blk[11] ^= kp[11]
	blk[12] ^= kp[12]
	blk[13] += kp[13]
	blk[14] += kp[14]
	blk[15] ^= kp[15]

	dst[3] = __blk[0]
	dst[2] = __blk[1]
	dst[1] = __blk[2]
	dst[0] = __blk[3]
}

// *********************************************************************************************************************
// * SUMMARY: none.                                                                                                    *
// * WARNING: none.                                                                                                    *
// * HISTORY:                                                                                                          *
// *    -create: 2023/10/30 16:12:55 ColeCai.                                                                          *
// *********************************************************************************************************************
func decrypt(xk []byte, kBytes uint32, dst, src []uint32) {
	__blk := make([]uint32, 16)
	blk := tools.IntegersToBytes(__blk)

	__blk[3] = src[0]
	__blk[2] = src[1]
	__blk[1] = src[2]
	__blk[0] = src[3]

	kp := xk[16*kBytes:]

	blk[0] ^= kp[0]
	blk[1] -= kp[1]
	blk[2] -= kp[2]
	blk[3] ^= kp[3]
	blk[4] ^= kp[4]
	blk[5] -= kp[5]
	blk[6] -= kp[6]
	blk[7] ^= kp[7]
	blk[8] ^= kp[8]
	blk[9] -= kp[9]
	blk[10] -= kp[10]
	blk[11] ^= kp[11]
	blk[12] ^= kp[12]
	blk[13] -= kp[13]
	blk[14] -= kp[14]
	blk[15] ^= kp[15]

	if kBytes > 24 {
		doIr(blk, xk[480:])
		doIr(blk, xk[448:])
		doIr(blk, xk[416:])
		doIr(blk, xk[384:])
	}

	if kBytes > 16 {
		doIr(blk, xk[352:])
		doIr(blk, xk[320:])
		doIr(blk, xk[288:])
		doIr(blk, xk[256:])
	}

	doIr(blk, xk[224:])
	doIr(blk, xk[192:])
	doIr(blk, xk[160:])
	doIr(blk, xk[128:])
	doIr(blk, xk[96:])
	doIr(blk, xk[64:])
	doIr(blk, xk[32:])
	doIr(blk, xk)

	dst[3] = __blk[0]
	dst[2] = __blk[1]
	dst[1] = __blk[2]
	dst[0] = __blk[3]
}
